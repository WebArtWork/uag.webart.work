import{q as l,t as o}from"./chunk-KRWE5CTW.js";import{C as r,O as h,y as c}from"./chunk-YWXTHJOJ.js";import{h as n}from"./chunk-CIWMVH6F.js";var _=(()=>{class s extends o{constructor(){super({name:"translatephrase",unauthorized:!0}),this.phrases=h(this.getDocs()),this._phrasesByText={},this._creating={},this._syncPending=!1,this._initialized=!1,this._emitter=r(l),this.ready=new Promise(e=>{this._readyResolve=e}),this.filteredDocuments(this._phrasesByText,{field:"text",filtered:()=>this._scheduleSync()}),this.get().subscribe(()=>{this._scheduleSync(),this._initialized=!0,this._readyResolve?.()})}getByText(e){return this._phrasesByText[e]?.[0]}hasText(e){return!!this.getByText(e)}ensurePhrase(e){return n(this,null,function*(){if(e){if(!this._initialized)try{yield this.ready}catch{return}this.hasText(e)||this._creating[e]||(this._creating[e]=!0,this.create({text:e}).subscribe({error:()=>{delete this._creating[e]},complete:()=>{delete this._creating[e]}}))}})}_scheduleSync(){this._syncPending||(this._syncPending=!0,queueMicrotask(()=>{this._syncPending=!1,this.phrases.set(this.getDocs()),this._emitter.emit("translatephrase_changed")}))}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();var I=(()=>{class s extends o{constructor(){super({name:"translate",unauthorized:!0,replace:e=>{e.slug=e.phrase+e.language}}),this._phraseService=r(_),this._emitterService=r(l),this._translates={},this._signalTranslates={},this._languageId="",this._recalcPending=!1,this._recalcInProgress=!1,this.filteredDocuments(this._translates,{field:"slug",filtered:()=>this._scheduleRecalc()}),this._emitterService.on("languageId").subscribe(e=>{this.loadTranslate(e)}),this._emitterService.on("translatephrase_changed").subscribe(()=>this._scheduleRecalc())}loadTranslate(e){this._languageId!==e&&(this._languageId=e,this.get({query:"language="+e}).subscribe(()=>{this._scheduleRecalc()}))}translate(e){return this._signalTranslates[e]||(this._signalTranslates[e]=h(this._getTranslation(e)),queueMicrotask(()=>void this._phraseService.ensurePhrase(e))),this._signalTranslates[e]}updateTranslation(e,t,a){return n(this,null,function*(){let i=yield this.getDoc(u=>u.language===a&&u.phrase===t);i?(i.text=e,i.text!==e&&this.update(i)):this.create({language:a,phrase:t,text:e})})}_scheduleRecalc(){this._recalcPending||(this._recalcPending=!0,queueMicrotask(()=>{this._recalcPending=!1,this._reTranslateNow()}))}_reTranslateNow(){if(!this._recalcInProgress){this._recalcInProgress=!0;try{for(let e of Object.keys(this._signalTranslates)){let t=this._getTranslation(e);this._signalTranslates[e]()!==t&&this._signalTranslates[e].set(t)}}finally{this._recalcInProgress=!1}}}_getTranslation(e){let t=this._phraseService.getByText(e);if(t&&this._languageId){let a=t._id+this._languageId,i=this._translates[a];if(i?.length)return i[0].text}return e}static{this.\u0275fac=function(t){return new(t||s)}}static{this.\u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{_ as a,I as b};
