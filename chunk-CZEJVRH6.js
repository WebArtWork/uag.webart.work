import{a as de}from"./chunk-QDH4MIVX.js";import{a as ce,f as ae}from"./chunk-RB45GIYM.js";import{k as A,r as se,s as me,t as U,w as V,y as le}from"./chunk-KRWE5CTW.js";import{C as p,Fa as Z,G as W,Ga as x,H as f,I as _,Ia as b,Jb as re,K as G,Ka as c,O as h,P as D,Q,Wa as k,Xa as j,Y as g,Ya as ee,Za as te,ca as v,cb as ne,db as B,eb as J,gb as $,ha as X,hb as E,jb as T,kb as oe,nb as ie,qa as O,ra as P,ta as Y,tb as R,ua as F,va as S,vb as M,wa as C,wb as a,xa as l,y as q,ya as u}from"./chunk-YWXTHJOJ.js";import{a as y,b as K}from"./chunk-CIWMVH6F.js";var pe=(()=>{class o extends U{constructor(){super({name:"formcomponent"}),this.components=h([]),this.get({query:"appId="+V.appId}),this.loaded.subscribe(()=>{this.components.set(this.getDocs())})}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=q({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var Ce=()=>[],ue=()=>({}),be=(o,m,e,t,n,i,r,s,d,w,I,ge,he)=>({props:o,config:m,component:e,wFormId:t,wFormKey:n,wSubmit:i,wChange:r,wClick:s,model:d,fieldTree:w,field:I,submition:ge,key:he}),we=o=>({$implicit:o}),ve=(o,m)=>m.key??o;function xe(o,m){if(o&1){let e=x();l(0,"form-component",3),b("wSubmit",function(){f(e);let n=c(3);return _(n.wSubmit.emit(n.submition()||{}))})("wChange",function(){f(e);let n=c(3);return _(n.wChange.emit())})("wClick",function(){f(e);let n=c(3);return _(n.wClick.emit())}),u()}if(o&2){let e=c(),t=e.$implicit,n=e.$index,i=c(2);k(E("wformc__item ",i.formId()," ",i.formId()+"_"+i.index()+"_"+n," ",t.class||"")),C("formId",i.formId())("component",t)("config",i.config())("submition",i.submition())("model",i.model())("fieldTree",i.fieldTree())("index",i.index()+"_"+n)}}function ye(o,m){if(o&1&&O(0,xe,1,12,"form-component",2),o&2){let e=m.$implicit;P(e.hidden?-1:0)}}function Me(o,m){if(o&1&&(l(0,"div"),F(1,ye,1,1,null,null,ve),u()),o&2){let e=c();k($("wformc ",e.component().class||"")),g(),S(e.component().components??T(3,Ce))}}function Fe(o,m){o&1&&Z(0)}function Se(o,m){if(o&1&&(l(0,"div",1),X(1,Fe,1,0,"ng-container",4),u()),o&2){let e=c();g(),C("ngTemplateOutlet",e.template())("ngTemplateOutletContext",oe(18,we,ie(4,be,[e.component().props||T(2,ue),e.config(),e.component(),e.formId(),e.effectiveKey(),e.submit.bind(e),e.change.bind(e),e.click.bind(e),e.model(),e.fieldTree(),e.field,e.submition()||T(3,ue),e.effectiveKey()])))}}var fe=(()=>{class o{constructor(){this._form=p(z),this.index=a(""),this.formId=a(""),this.config=a.required(),this.component=a.required(),this.submition=a({}),this.model=a(null),this.fieldTree=a(null),this.wSubmit=M(),this.wChange=M(),this.wClick=M(),this.template=h(null),D(()=>{this._form.templatesVersion();let e=this.component().name;this.template.set(e?this._form.getTemplateComponent(e):null)})}hasChildren(){return Array.isArray(this.component().components)&&!!this.component().components?.length}effectiveKey(){let e=this.component().key;if(!e)return null;if(!e.includes("[]"))return e;let t=(this.index()||"").split("_").pop()||"0",n=Number.isFinite(+t)?+t:0;return e.replace(/\[\]/g,`[${n}]`)}get field(){let e=this.fieldTree(),t=this.effectiveKey();return!e||!t?null:e[t]}submit(){this.wSubmit.emit(this.submition()||{})}change(){this.wChange.emit()}click(){this.wClick.emit()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["form-component"]],inputs:{index:[1,"index"],formId:[1,"formId"],config:[1,"config"],component:[1,"component"],submition:[1,"submition"],model:[1,"model"],fieldTree:[1,"fieldTree"]},outputs:{wSubmit:"wSubmit",wChange:"wChange",wClick:"wClick"},decls:2,vars:1,consts:[[3,"class"],[1,"wformc"],[3,"class","formId","component","config","submition","model","fieldTree","index"],[3,"wSubmit","wChange","wClick","formId","component","config","submition","model","fieldTree","index"],[4,"ngTemplateOutlet","ngTemplateOutletContext"]],template:function(t,n){t&1&&O(0,Me,3,4,"div",0)(1,Se,2,20,"div",1),t&2&&P(n.hasChildren()?0:n.component().name&&n.template()?1:-1)},dependencies:[o,re],styles:["[_nghost-%COMP%]{display:block;position:relative}.wformc[_ngcontent-%COMP%]{position:relative;padding:0}.wformc__item[_ngcontent-%COMP%]{display:block;margin:0 0 10px}"],changeDetection:0})}}return o})();var ke=()=>({}),Te=(o,m)=>m.key??o;function Ie(o,m){if(o&1&&(l(0,"h1",0),j(1),u()),o&2){let e=c();g(),ee(e.title)}}function De(o,m){if(o&1){let e=x();l(0,"form-component",3),b("wSubmit",function(){f(e);let n=c();return _(n.onSubmit())})("wChange",function(){f(e);let n=c();return _(n.onLegacyChange())})("wClick",function(){f(e);let n=c();return _(n.onClick())}),u()}if(o&2){let e=m.$implicit,t=m.$index,n=c(),i=J(0),r=J(1);k(E("wform__component ",n.formId," ",n.formId+"_"+t," ",e.class||"")),C("formId",n.formId)("component",e)("config",i)("submition",r)("model",n.model)("fieldTree",n.fieldTree)("index",""+t)}}var L=(()=>{class o{constructor(){this._coreService=p(A),this._formService=p(z),this._formcomponentService=p(pe),this.config=a.required(),this.submition=a({}),this.wChange=M(),this.wSubmit=M(),this._components=R(()=>this.config()?.components??[]),this.visibleComponents=R(()=>this._components().filter(e=>!e?.hidden).concat(this._formcomponentService.components().filter(e=>e.formId===this.formId))),this.instance=h(null),D(()=>{let e=this.config(),t=this.submition();if(!e)return;let n=Q(()=>this._formService.form(e,t??void 0));this.instance.set(n)}),D(()=>{let e=this.instance();if(!e)return;let t=e.model();this.wChange.emit(t)})}get formId(){return this.instance()?.id??""}get fieldTree(){return this.instance()?.form??null}get model(){return this.instance()?.model??null}get title(){return this.config()?.title}get cssClass(){return this.config()?.class??""}onSubmit(){let e=this.instance(),t=e?e.model():{};this.wSubmit.emit(t)}onLegacyChange(){let e=this.instance(),t=e?e.model():{};this._coreService.afterWhile(this,()=>this.wChange.emit(t),150)}onClick(){}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["wform"]],inputs:{config:[1,"config"],submition:[1,"submition"]},outputs:{wChange:"wChange",wSubmit:"wSubmit"},decls:7,vars:7,consts:[[1,"wform__title"],[1,"wform__body",3,"submit"],[3,"class","formId","component","config","submition","model","fieldTree","index"],[3,"wSubmit","wChange","wClick","formId","component","config","submition","model","fieldTree","index"]],template:function(t,n){if(t&1){let i=x();ne(0)(1),l(2,"div"),O(3,Ie,2,1,"h1",0),l(4,"form",1),b("submit",function(s){return f(i),s.preventDefault(),_(n.onSubmit())}),F(5,De,1,12,"form-component",2,Te),u()()}if(t&2){B(n.config());let i=n.submition();g(),B(i||T(6,ke)),g(),k($("wform ",n.cssClass)),g(),P(n.title?3:-1),g(2),S(n.visibleComponents())}},dependencies:[fe],styles:[".wform[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;row-gap:12px;width:100%}.wform__title[_ngcontent-%COMP%]{margin:0 0 10px;color:var(--c-text-primary);font-weight:600;font-size:20px;line-height:1.2;letter-spacing:var(--letter-spacing, 0)}.wform__body[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr;gap:12px;width:100%}.wform__component[_ngcontent-%COMP%]{display:block;width:100%}.wform__input[_ngcontent-%COMP%], .wform__textarea[_ngcontent-%COMP%], .wform__select[_ngcontent-%COMP%]{width:100%;display:block;border:1px solid var(--c-border);border-radius:var(--b-radius, 8px);background:transparent;color:var(--c-text-secondary);font-size:var(--fs, 16px);line-height:1.25;padding:10px 12px;transition:var(--transition, .15s ease)}.wform__input[_ngcontent-%COMP%]::placeholder, .wform__textarea[_ngcontent-%COMP%]::placeholder, .wform__select[_ngcontent-%COMP%]::placeholder{color:var(--c-placeholder);transition:inherit}.wform__input[_ngcontent-%COMP%]:focus, .wform__textarea[_ngcontent-%COMP%]:focus, .wform__select[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--c-primary)}.wform__input[_ngcontent-%COMP%]:disabled, .wform__textarea[_ngcontent-%COMP%]:disabled, .wform__select[_ngcontent-%COMP%]:disabled{background:var(--c-grey);border-color:var(--c-grey);color:var(--c-grey);opacity:.6;cursor:default}.wform__textarea[_ngcontent-%COMP%]{min-height:88px;resize:vertical}.wform__select[_ngcontent-%COMP%]{appearance:none;padding-right:30px;position:relative}.wform--two-col[_ngcontent-%COMP%]   .wform__body[_ngcontent-%COMP%]{grid-template-columns:repeat(2,minmax(0,1fr))}@media(max-width:768px){.wform__body[_ngcontent-%COMP%]{grid-template-columns:1fr!important}}"],changeDetection:0})}}return o})();function Oe(o,m){if(o&1){let e=x();l(0,"wbutton",6),b("wClick",function(){let n=f(e).$implicit,i=c();return _(i.onButtonClick(n))}),j(1),u()}if(o&2){let e=m.$implicit,t=c();C("extraClass","w-btn _primary "+(e.class||""))("disabled",t.submitting()),g(),te(" ",e.label," ")}}var H=(()=>{class o{constructor(){this._coreService=p(A),this.submit=e=>{},this.change=e=>{},this.submitting=h(!1)}_sync(e){if(!e)return;this._coreService.copy(e,this.submition);let t=e.data;t&&typeof t=="object"&&(this.submition.data=this.submition.data||{},this._coreService.copy(t,this.submition.data))}handleSubmit(e){this.submitting.set(!0);try{this._sync(e),this.submit(this.submition),this.close()}finally{this.submitting.set(!1)}}handleChange(e){this._sync(e),this.change(this.submition)}onButtonClick(e){this.submitting()||e.click(this.submition,this.close)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["ng-component"]],decls:7,vars:2,consts:[["formRef",""],[1,"modal-form"],[1,"modal-form__body"],[3,"wSubmit","wChange","config","submition"],[1,"modal-form__actions"],[3,"extraClass","disabled"],[3,"wClick","extraClass","disabled"]],template:function(t,n){if(t&1){let i=x();l(0,"div",1)(1,"div",2)(2,"wform",3,0),b("wSubmit",function(s){return f(i),_(n.handleSubmit(s))})("wChange",function(s){return f(i),_(n.handleChange(s))}),u()(),l(4,"div",4),F(5,Oe,2,3,"wbutton",5,Y),u()()}t&2&&(g(2),C("config",n.form)("submition",n.submition),g(3),S(n.modalButtons))},dependencies:[L,le],styles:["[_nghost-%COMP%]{display:block;max-block-size:100%}.modal-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;min-block-size:100%}.modal-form__body[_ngcontent-%COMP%]{flex:1 1 auto;min-block-size:0;padding-block-end:6rem}.modal-form__actions[_ngcontent-%COMP%]{position:sticky;inset-block-end:calc(-1 * var(--sp-4));margin-top:var(--sp-4);padding-block-start:var(--sp-3);padding-block-end:var(--sp-3);background:var(--c-bg-secondary)}.modal-form__actions[_ngcontent-%COMP%]   .w-btn[_ngcontent-%COMP%]{width:100%;display:block}"],changeDetection:0})}}return o})();var _e=(()=>{class o{constructor(){this._http=p(se),this.form=a.required(),this.module=a.required(),this.field=a.required(),this.doc=a.required()}get getDoc(){return this.doc()}change(e){this._http.post(`/api/${this.module()}/unique${this.field()||""}`,this.doc()).subscribe(t=>{this.doc()[this.field()]!==t&&(this.doc()[this.field()]=t)})}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=v({type:o,selectors:[["ng-component"]],inputs:{form:[1,"form"],module:[1,"module"],field:[1,"field"],doc:[1,"doc"]},decls:1,vars:2,consts:[[3,"wChange","config","submition"]],template:function(t,n){t&1&&(l(0,"wform",0),b("wChange",function(r){return n.change(r)}),u()),t&2&&C("config",n.form())("submition",n.getDoc)},dependencies:[L],encapsulation:2,changeDetection:0})}}return o})();var z=(()=>{class o extends U{constructor(){super({name:"form"}),this._modalService=p(de),this._storeService=p(me),this._injector=p(G),this.appId=V.appId,this._templateComponent=new Map,this.templatesVersion=h(0),this.templateFields={},this.customTemplateFields={},this.forms=[],this.formIds=h([]),this._signalForms=new Map,this._storeService.getJson("formIds",e=>{Array.isArray(e)&&this.formIds.set(e)}),this.get({query:"appId="+V.appId})}addTemplateComponent(e,t){this._templateComponent.has(e)||(this._templateComponent.set(e,t),this.templatesVersion.update(n=>n+1))}removeTemplateComponent(e){this._templateComponent.delete(e)&&this.templatesVersion.update(t=>t+1)}getTemplateComponent(e){return this._templateComponent.get(e)??null}getTemplateComponentsNames(){return Array.from(this._templateComponent.keys())}getTemplateFields(e){return this.templateFields[e]||["Placeholder","Label"]}setTemplateFields(e,t,n={}){this.templateFields[e]=t,this.customTemplateFields[e]=y(y({},this.customTemplateFields[e]||{}),n)}getCustomTemplateFields(e){return this.customTemplateFields[e]||{}}getDefaultForm(e,t=["name","description"]){this._rememberFormId(e);let n=t.map((i,r)=>{let s=i.includes(".")?i.split(".")[1]:"Text",d=(i.split(".")[0]||i).replace(/\[\]|\[\d+\]/g,"");return{name:s,key:i,focused:r===0,props:{placeholder:`Enter your ${d}`,label:d.charAt(0).toUpperCase()+d.slice(1)}}});return{formId:e,components:n}}form(e,t){e.formId&&this._rememberFormId(e.formId);let n=e.formId||crypto.randomUUID();e.formId=n;let i=this._signalForms.get(n);if(i)return t&&Object.keys(t).length&&i.model.update(I=>y(y({},I),t)),i;let r=this._buildInitialModel(e,t??{}),s=h(r),d=W(this._injector,()=>ce(s,I=>{this._applyValidators(I,e)})),w={id:n,model:s,form:d};return this._signalForms.set(n,w),w}_buildInitialModel(e,t={}){let n=y({},t);return this._traverseComponents(e.components,i=>{i.key&&(i.key in n||(n[i.key]=null))}),n}_applyValidators(e,t){this._traverseComponents(t.components,n=>{if(!n.key)return;let i=e[n.key];if(!i)return;let r=n.props?.label??n.key;n.required&&ae(i,{message:`${r} is required`})})}_traverseComponents(e,t){if(e?.length)for(let n of e)t(n),n.components?.length&&this._traverseComponents(n.components,t)}modal(e,t=[],n={data:{}},i=s=>{},r={}){return(Array.isArray(e)?e:[e]).forEach(d=>this.form(d,n)),new Promise(d=>{this._modalService.show(K(y({},r),{component:H,class:"forms_modalService",size:"big",form:e,modalButtons:Array.isArray(t)?t:[t],submition:n,onClose:()=>d(n),submit:w=>d(w),change:w=>{typeof i=="function"&&i(w)}}))})}modalDocs(e,t="Modify content of documents"){return new Promise(n=>{let i={docs:JSON.stringify(e.length?e:[],null,4)};this._modalService.show({component:H,class:"forms_modalService",size:"big",submition:i,form:{title:t,components:[{name:"Ace",key:"docs",props:{placeholder:"Fill content of documents..."}}]},modalButtons:[{label:"Update",click:(r,s)=>{s();let d=i.docs?JSON.parse(i.docs):[];n(d)}}]})})}modalUnique(e,t,n,i="",r=()=>{}){let s=this.getDefaultForm("unique",[t+(i?"."+i:"")]);this.form(s,n),this._modalService.show({component:_e,form:s,module:e,field:t,doc:n,class:"forms_modalService",onClose:r})}getComponent(e,t){return this._getComponent(e.components,t)||{}}getProp(e,t,n){return this.getComponent(e,t)?.props?.[n]??null}setProp(e,t,n,i){let r=this.getComponent(e,t);r&&(r.props=r.props||{},r.props[n]=i)}_getComponent(e=[],t){for(let n of e||[]){if(n.key===t)return n;if(n.components?.length){let i=this._getComponent(n.components,t);if(i)return i}}return null}_rememberFormId(e){e&&(this.formIds().includes(e)||(this.formIds.update(t=>(t.push(e),t)),this._storeService.setJson("formIds",this.formIds())))}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=q({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{pe as a,z as b};
